---
title: "Calibrate parameter with a New Dataset"
---

After [loading](https://solenepety.github.io/RITHMS/docs/articles/import-data.html) your own dataset, we recommended performed a quick diagnosis to guide the choice of parameters in the `holo_simu()` simulation framework. This vignette aims to support users in calibrating simulation to best fit the patterns of their dataset.

The parameters concerned by the diagnosis proposed in this vignette are : 

- **The genetic effect size** $\sigma \beta$, which controls the structure of QTLs effects across microbiome. 
- **The simulated ambient microbiome**, estimated in the `compute_mean_microbiome()` function by averaging abundances across individuals for each taxa and optionally using Dirichlet distribution.

- **The multinomial sampling size parameter**, used to perform the multinomial sampling stap that converts abundances to counts data. 


```{r}
library(magrittr)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(paletteer)
library(data.table)
library(glue)
library(psych)
```

## The genetic effect size

This parameter directly affect the distribution of taxa heritabilities. The `gen_effect_calibration()` function helps evaluate how different values of $\sigma \beta$ shape this distribution. In practice, it is often reasonable to expect the majority of taxa have heritabilities on the order of 0.1, with maximum values of no more than 0.5 [Zang et al.](https://pubmed.ncbi.nlm.nih.gov/36102532/).


```{r}
taxa_assign_g <- assign_taxa(founder_object = ToyData)
effect_size_vector <- c(seq(0.1, 1, by = 0.1))
out_data <- gen_effect_calibration(founder_object = ToyData,
                                   taxa_assign_g = taxa_assign_g,
                                   correlation = 0.5,
                                   effect.size = effect_size_vector,
                                   plot = TRUE)
```

**Select the effect size values for taxa heritabilities distributions that are in line with the recommendations:**

```{r}
density_peaks <- out_data %>%
  group_by(effect.size) %>%
  summarise(
    peak = density(Heritability)$y[which.max(density(Heritability)$y)],
    peak_x = density(Heritability)$x[which.max(density(Heritability)$y)]
  )

density_peaks <- density_peaks %>% filter(peak_x <= 0.5)


out_data_filtered <- out_data %>% semi_join(density_peaks, by = "effect.size")

p2 <- out_data_filtered %>% ggplot(aes(x=Heritability,fill=as.factor(effect.size), label = as.factor(effect.size))) +
    geom_density(alpha=0.5, color = NA)+
    coord_cartesian(xlim = range(out_data$Heritability, density_peaks$peak_x))+

    geom_text_repel(
      data = density_peaks,
      aes(x = peak_x, y = peak, label = effect.size, color = as.factor(effect.size)),
      nudge_x = 0.01,
      nudge_y = 0.3,
      direction = "y",
      show.legend = FALSE) +
    labs(x = "Taxa heritability",
         y = "Density",
         fill = "Genetic effect size",
         title = "Taxa heritability density, noise 0.5")+
    theme(panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(colour="#e3e3e3"),
          panel.grid.minor = element_line(colour="#e9e9e9"),
          axis.title = element_text(size = 8),
          axis.text = element_text(size=7),
          plot.title = element_text(size=7),
          legend.position = "right") +
  
  scale_fill_paletteer_d("werpals::uyuni") +
  scale_color_paletteer_d("werpals::uyuni")
 p2
```

According to [Zang et al.](https://pubmed.ncbi.nlm.nih.gov/36102532/) expectation, a reasonable distribution of taxa heritabilies appears to correspond to a value of $\sigma \beta * \sqrt {QTL_o} = 0.3$ in the case of [DÃ©ru et al. 2020](https://pmc.ncbi.nlm.nih.gov/articles/PMC7538339/) dataset.

## The simulated ambient microbiome

The main parameter of the Dirichlet distribution is $\alpha$ which is a concentration parameter that controls the distribution of admixture proportions between populations. It is used here to induce a certain inter-individual variability in relative abundance values. Its calibration depends on both the size of the dataset and its structure.

To detect a potentially poorly simulated ambient microbiota, we look at the Shannon Diversity distribution across generations as function $\lambda$, the proportion of vertical transmission.

The composition of the microbiota of individuals are given by this equation : $\lambda \textbf{M}^{t-1}_{d(i)} + (1- \lambda) \textbf{M}^{(t)}_{a(i)}$. With $\lambda = 0$ corresponds to no vertical transmission, therefore only based on the ambient microbiota.

**Perform simulations over 5 generations for each value of lambda:** 

```{r}
lambda = c(0, 0.3, 0.5, 0.7,1)

taxa_assign_g <- assign_taxa(founder_object)

gen_simu <- map(lambda, function(l) {
  print(glue("Lambda : {l}"))
  
  holo_simu(
    h2 = 0.25,
    b2 = 0.25,
    founder_object = founder_object,
    n_clust = taxa_assign_g,
    n_ind = 500,
    lambda = l,
    dir = TRUE,
    seed = 8082
  )
})

names(gen_simu) <- as.character(lambda)
```

**Retrieve the Shannon diversities for each simulation:**

```{r}
diversities_microbiomes_lambdas <- map_dfr(names(gen_simu), function(l) {
  gen_simu[[l]][-1] %>%
    map(get_microbiomes) %>%
    map(richness_from_abundances_gen) %>%
    bind_rows(.id = "Generation") %>%
    mutate(lambda = l)
})
```


**Shannon's diversity density:**

```{r}
p <- ggplot(diversities_microbiomes_lambdas,aes(x=Shannon,y=Generation,fill=lambda, color = lambda)) +
        geom_density_ridges(alpha=0.5, scale = 1) + 
        theme_minimal() +
        labs(
              title = "Shannon diversity accross generation as function Lambda",
              x = "Shannon Diversity",
              y = "Generation",
              fill = "Lambda",
              color = "Lambda"
            ) +
        scale_fill_paletteer_d("beyonce::X77") +
        scale_color_paletteer_d("beyonce::X77")
  
p
```

A significant shift between G0 diversity and G1 diversity may be a symptom of a poorly simulated ambient microbiome. With the decrease of $\lambda$ this shift appears stronger. Indeed, this corresponds to a horizontal transmission only, therefore a very strong weight of the simulated ambient microbiome.

**How to optimize the Dirichlet microbiome distribution?**

*Work in progess...*

## The multinomial sampling size parameter

The default value of this parameter (10 000) such as $M(10000, (p_{i,1}, ..., p_{i,n_b}))$ is actually calibrate to fit with the [toy dataset](https://pmc.ncbi.nlm.nih.gov/articles/PMC7538339/).
This parameter is based on the average sequencing depth observed in the dataset. To optimize the value, a quick exploration of the distribution of sequencing depths from the counting table is performed.


**Sequencing depths distribution:**

```{r}
datafile <- system.file("DeruPop.rds", package = "RITHMS")
ToyData <- readRDS(datafile)
```

```{r}
sample_depth <- rowSums(ToyData)

mean_geom_depth <- geometric.mean(sample_depth)
median_depth <- median(sample_depth)
q1_depth <- quantile(sample_depth, 0.25)
q3_depth <- quantile(sample_depth, 0.75)

abline_data <- data.frame(
  x = c(mean_geom_depth, median_depth, q1_depth, q3_depth),
  label = c(
    sprintf("Mean geom: %.0f", mean_geom_depth),
    sprintf("Median: %.0f", median_depth),
    sprintf("Q1: %.0f", q1_depth),
    sprintf("Q3: %.0f", q3_depth)
  ),
  color = c("black", "red", "orange", "orange"),
  linetype = c("solid", "solid", "dotted", "dotted")
)

ggplot(data.frame(Depth = sample_depth), aes(x = Depth)) +
  geom_histogram(bins = 120, alpha = 0.3, fill = "#1f618d", color = "#1f618d") +
  geom_vline(data = abline_data, aes(xintercept = x, color = label, linetype = label),size = 0.8) +
  labs(title = "Sequencing depths distribution",
       x = "Sequencing depth",
       y = "Number of samples") +
  
  scale_color_manual(values = setNames(abline_data$color, abline_data$label)) +
  scale_linetype_manual(values = setNames(abline_data$linetype, abline_data$label)) +
  theme_minimal() +
  theme(legend.title = element_blank())
```

As defined as the default value in the `richness_from_abundances_gen()`, we find results close to 10 000. 
*Work in progress...*



