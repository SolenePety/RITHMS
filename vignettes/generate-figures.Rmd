---
title: "Generate paper figures"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate figures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,
                      warning=FALSE,
                      results="asis",
                      echo = FALSE,
                      collapse = TRUE,
                      comment = "#>")
```

```{r init,message=FALSE,warning=FALSE,results="asis",echo=FALSE}
library(RITHMS)
library(MoBPS)
library(dplyr)
library(compositions)
library(glue)
library(purrr)
library(bazar)
library(dirmult)
library(stringr)
library(ComplexHeatmap)
library(circlize)
library(ggplot2)
library(cowplot)
library(phyloseq)
library(tidyr)
library(ggrepel)
library(ggridges)
library(ggh4x)
library(furrr)
library(peakRAM)
```

```{r}
greens_pal <- c("#6df17c","#2ede41","#26c537","#1da42c","#157e21","#0E5e17")
```

```{r}
datafile <- system.file("DeruPop.rds", package = "RITHMS")
founder_object <- readRDS(datafile)
```

# **Fig 3. Microbiome : simulation reflects structure of microbiome**
  
## **A. Correlation heatmap**  
  
```{r}
taxa_assign_g_small <- assign_taxa(founder_object, 
                                   taxa_g = 0.04)


noise = 0.6
effect.size = 0.3
lambda = 0.5
center_bg = T
dir = T
generations_simu <- holo_simu(h2 = 0.25,
                              b2 = 0.25,
                              founder_object = founder_object,
                              n_clust = taxa_assign_g_small,
                              n_ind = 500,
                              verbose = F,
                              noise.microbiome = noise,
                              effect.size = effect.size,
                              lambda = lambda,
                              dir = dir,
                              selection = F,
                              seed = 333)

```

```{r}
#Correlation intra-cluster for cluster under genetic control
beta <- generations_simu$metadata$Beta_matrix[taxa_assign_g_small != 0,]
cor_matrix <- cor(t(beta))
taxa_order <- taxa_assign_g_small[taxa_assign_g_small != 0] %>% order()
cor_matrix <- cor_matrix[taxa_order,taxa_order]

pal <- colorRampPalette(RColorBrewer::brewer.pal(5,"Set1"))(length(taxa_assign_g_small[taxa_assign_g_small != 0] %>% unique()))
clus_col <- structure(pal, names = taxa_assign_g_small[taxa_assign_g_small != 0] %>% unique() %>% as.vector())

leftAnn = rowAnnotation(clust = taxa_assign_g_small[taxa_assign_g_small != 0] %>% sort(),
                        col = list(clust = clus_col),
                        show_annotation_name = F,
                        annotation_legend_param = list(clust = list(title = "Cluster ID",title_gp = gpar(fontsize = 5, fontface = "bold"), labels_gp = gpar(fontsize = 5, fontface = 'bold'))))
colAnn = HeatmapAnnotation(clust = taxa_assign_g_small[taxa_assign_g_small != 0] %>% sort(),
                        col = list(clust = clus_col),
                        show_annotation_name = F,
                        show_legend = FALSE)

col_fun = colorRamp2(c(min(cor_matrix), 0, max(cor_matrix)), c("blue", "white", "red"))

p1 <- grid.grabExpr(draw(Heatmap(cor_matrix, 
        cluster_rows = F, 
        cluster_columns = F, 
        show_row_names = F, 
        show_column_names = F,
        left_annotation = leftAnn,
        top_annotation = colAnn,
        #col = col_fun,
        heatmap_legend_param = list(title = "Correlation", title_gp = gpar(fontsize = 5, fontface = "bold"), labels_gp = gpar(fontsize = 5, fontface = 'bold')))))

#plot_grid(p1)
```

## **B. Lambda values**  
  
```{r}
set.seed(484)
#Change n_it to increase the accuracy of the function, n_it = 10 used in the article
n_it = 1
seed_value <- sample(c(100:9999),n_it)

taxa_assign_g <- assign_taxa(founder_object)
```

```{r}
noise = 0.1
effect.size = 0.1
center_bg = T
dir = T
lambda = c(0,0.5,1)

#Boxplot lambda vs diversity correlation with offspring
  cor_gen_table <- data.frame()
  for(s in seed_value){
    print(glue("Seed : {s}"))
    for(l in lambda){
      print(glue("Lambda : {l}"))
      generations_simu <- holo_simu(h2 = 0.25,
                                    b2 = 0.25,
                                    founder_object = founder_object,
                                    n_clust = taxa_assign_g,
                                    n_ind = 500,
                                    verbose = F,
                                    noise.microbiome = noise,
                                    effect.size = effect.size,
                                    lambda = l,
                                    dir = dir,
                                    selection = F,
                                    seed = s)

      current_div <- generations_simu$G2$microbiome %>% richness_from_abundances_gen()
      previous_s_div <- sapply(generations_simu$G2$pedigree[,"father"],function(x){generations_simu$G1$microbiome[,x]}) %>% richness_from_abundances_gen()
      previous_d_div <- sapply(generations_simu$G2$pedigree[,"mother"],function(x){generations_simu$G1$microbiome[,x]}) %>% richness_from_abundances_gen()
      ambient_div <- generations_simu$G2$mean_microbiome %>% richness_from_abundances_gen()
      cor_gen_table <- rbind(cor_gen_table,
                           cbind(l,
                                 cor(current_div$Shannon,previous_d_div$Shannon),
                                 cor(current_div$Shannon,previous_s_div$Shannon),
                                 cor(current_div$Shannon,ambient_div$Shannon)))
    }
  }
  colnames(cor_gen_table) <- c("lambda","Mother","Father","Ambient")
  long_cor_gen <- cor_gen_table %>% pivot_longer(c("Mother","Father","Ambient"),
                                                 names_to = "cor_type",
                                                 values_to = "value")
```

```{r}

lambda_label <- cbind(x = c(0,0.5,1),
                      y = c(0.8,0.2,0.8),
                      label = c("Ambient","Father","Mother")) %>% as.data.frame()
lambda_label$y <- as.numeric(lambda_label$y)

p3 <- long_cor_gen %>% summarise(value = mean(value), .by = c(lambda, cor_type)) |> ggplot(aes(x=as.factor(lambda),y=value,col=cor_type, group = cor_type)) +
  geom_line() +
  geom_point( alpha=0.8)  +
  geom_text_repel(data = lambda_label,
                  aes(x = x, y = y, label = label, color = label, group = NULL),
        direction = "y",
        show.legend = FALSE) +
  theme(panel.background = element_rect(fill="white"),
        panel.grid.major = element_line(colour="#e3e3e3"),
        panel.grid.minor = element_line(colour="#e9e9e9"),
        axis.title = element_text(size = 8),
        axis.text = element_text(size=7),
        plot.title = element_text(size=12),
        legend.key.size = unit(0.25, 'cm'), #change legend key size
        legend.title = element_text(size=7), #change legend title font size
        legend.text = element_text(size=7),
        legend.position = "none") +
  ylab("Correlation value") +
  xlab("Lambda") +
  labs(col = "Parents") +
  guides(shape = "none") +
  ylim(0,1) +
  scale_color_brewer(palette = "Dark2")

p3
```

## **C. Taxa heritability according to genetic effect**  
  
```{r}

out_data <- gen_effect_calibration(founder_object = founder_object,
                                   taxa_assign_g = taxa_assign_g,
                                   correlation = 0.5,
                                  effect.size = c(0.3,0.6,1),
                                  plot = F)


  # Calculate density peaks
density_peaks <- out_data %>%
  group_by(effect.size) %>%
  summarise(
    peak = density(Heritability)$y[which.max(density(Heritability)$y)],
    peak_x = density(Heritability)$x[which.max(density(Heritability)$y)]
  )

  p2 <- out_data %>% ggplot(aes(x=Heritability,fill=as.factor(effect.size), label = as.factor(effect.size))) +
      geom_density(alpha=0.8, color = NA)+
      geom_text_repel(
        data = density_peaks,
        aes(x = peak_x, y = peak, label = effect.size, color = as.factor(effect.size)),
        nudge_x = 0.02,
        nudge_y = 0.3,
        direction = "y",
        show.legend = FALSE) +
      labs(x = "Taxa heritability",
           y = "Density",
           fill = "Genetic effect size")+
      theme(panel.background = element_rect(fill="white"),
            panel.grid.major = element_line(colour="#e3e3e3"),
            panel.grid.minor = element_line(colour="#e9e9e9"),
            axis.title = element_text(size = 8),
            axis.text = element_text(size=7),
            plot.title = element_text(size=7),
            legend.position = "none") +
    scale_fill_manual(values = c("#00AFBB", "#E7B800", "#FC4E07")) +
    scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07"))
 #p2
```
  
## **D. Shannon diversity across generation**   
  
```{r}
#TODO Ã  mettre dans flat_first
get_microbiomes <- function(data, transpose = F, CLR = F) {
  if(transpose){
    if(CLR){
      return(data |> pluck("microbiome") |> t() |> replace_zero() |> compositions::clr() |> as.data.frame())
    }else{
      return(data |> pluck("microbiome") |> t() |> as.data.frame())
    }
  }
  data |> pluck("microbiome") |> as.data.frame()
}

get_mean_phenotypes <- function(data) {
  data |> pluck("phenotypes","y") |> mean()
}

get_phenotypes_value <- function(data,value = "gq") {
  data |> pluck("phenotypes",value)
}

get_om_beta_g <- function(data) {
  data |> pluck("omega_beta_g")
}

get_selected_ind <- function(data) {
  data |> pluck("ID_selected")
}
```
  
```{r}
h2 = 0.25
b2 = 0.25
generations_simu <- holo_simu(h2 = h2,
                              b2 = b2,
                              founder_object = founder_object,
                              n_clust = taxa_assign_g,
                              n_ind = 500,
                              verbose = F,
                              noise.microbiome = noise,
                              effect.size = effect.size,
                              lambda = 0.5,
                              dir = dir,
                              selection = F,
                              seed = 8082)

diversities_microbiomes <- generations_simu[-1] %>% map(get_microbiomes) %>% map(richness_from_abundances_gen) |> bind_rows(.id = "Generation")
  p4 <- ggplot(diversities_microbiomes,aes(x=Shannon,y=Generation,fill=Generation)) +
        geom_density_ridges(alpha=0.8) + 
        theme(legend.position = "none",
              panel.background = element_rect(fill="white"),
              panel.grid.major = element_line(colour="#e3e3e3"),
              panel.grid.minor = element_line(colour="#e9e9e9"),
              axis.title = element_text(size = 8),
              axis.text = element_text(size=7),
              plot.title = element_text(size=12),
              aspect.ratio = 1.5)+
  scale_fill_manual(values = rev(greens_pal))
  
#p4
```
  
## **Global**  
  
```{r}
top_row <- plot_grid(p1,p2, ncol = 2, labels = c("A","B"))
bottom_row <- plot_grid(p3,p4, ncol = 2, labels = c("C","D"))
plot_grid(top_row, bottom_row,nrow=2)
```

# **Fig 4. Environmental effect**
  
## **A. MDS antibio effect**    
  
```{r}
h2 = 0.25
b2 = 0.25
noise = 0.6
effect.size = 0.3
dir= T
n_ind = 500
lambda = 0.5

set.seed(42)
antibio <- rep(0, n_ind)
antibio_ind <- sample(1:n_ind, 250)
antibio[antibio_ind] <- 1 
X <- matrix(antibio, ncol = n_ind, nrow = 1)

# theta <- all taxa, big size effect with negative values
theta <- rnorm(ncol(founder_object),mean = 0, sd = 5)
theta <- ifelse(theta > 0, -theta, theta) %>% matrix(ncol = 1, nrow = ncol(founder_object))#Only negative values for all taxa

thetaX <- theta %*% X

generations_simu_env <- holo_simu(h2 = h2,
                                  b2 = b2,
                                  founder_object = founder_object,
                                  n_clust = taxa_assign_g,
                                  n_ind = n_ind,
                                  verbose = F,
                                  noise.microbiome = noise,
                                  effect.size = effect.size,
                                  lambda = lambda,
                                  dir = dir,
                                  selection = F,
                                  seed = 30,
                                  thetaX = thetaX,
                                  env_gen = c(F,T,F,F,F))
```

```{r}
diversities_microbiomes <- generations_simu_env[-1] %>% map(get_microbiomes) %>% map(richness_from_abundances_gen) |> bind_rows(.id = "Generation")

  p1 <- diversities_microbiomes %>% filter(!Generation %in% c("G4","G5")) %>%
    ggplot(aes(x=Shannon,y=Generation,fill=Generation)) +
    geom_density_ridges(alpha=0.8) + 
    theme(legend.position = "none",
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(colour="#e3e3e3"),
          panel.grid.minor = element_line(colour="#e9e9e9"),
          axis.title = element_text(size = 8),
          axis.text = element_text(size=7),
          plot.title = element_text(size=12),
          aspect.ratio = 1.5)+
    scale_fill_manual(values = rev(greens_pal)[1:4])
```
  
## **B. Diversity antibio effect**    
  
```{r}
microbiomes_all <- generations_simu_env[c(2,3,4,5)] %>% map(get_microbiomes, transpose = T, CLR = F) |> bind_rows(.id = "Generation")
                          
antibio_vec <- rep(0, nrow(microbiomes_all))
id_antibio_ind <- rownames(microbiomes_all)[which(microbiomes_all$Generation == "G1")] %in% colnames((generations_simu_env$G1$microbiome))[which(X != 0)]
antibio_vec[which(microbiomes_all$Generation == "G1")[id_antibio_ind]] <- 1
metadata <- cbind(Generation = microbiomes_all$Generation, ID = rownames(microbiomes_all), antibio = antibio_vec) |> as.data.frame()
rownames(metadata) <- metadata$ID

dist_mat <- vegan::vegdist(x = microbiomes_all[-1],
                 method = "bray")

physeq <- phyloseq(
  otu_table(t(microbiomes_all[,-1]), taxa_are_rows = TRUE),
  sample_data(metadata))

ord <- ordinate(physeq, method = "MDS", distance = dist_mat)

DF <- plot_ordination(physeq, ord, justDF = T)
p2 <- ggplot(data = DF, aes(x=DF[,1], y=DF[,2], color = antibio, shape=antibio)) + 
    labs(x = "Axis 1",
         y = "Axis 2") +
  geom_point(alpha = 0.8) + 
  theme(panel.background = element_rect(fill="white"),
            panel.grid.major = element_line(colour="#e3e3e3"),
            panel.grid.minor = element_line(colour="#e9e9e9"),
            axis.title = element_text(size = 8),
            axis.text = element_text(size=7),
            plot.title = element_text(size=7),
            legend.key.size = unit(0.25, 'cm'), #change legend key size
            legend.title = element_text(size=7), #change legend title font size
            legend.text = element_text(size=7),
            strip.text = element_text(color = "white", face = "bold")
        ) +
  facet_wrap2(~Generation, nrow = 2, ncol = 2, strip = strip_themed(background_x = elem_list_rect(fill = rev(greens_pal)[1:4])))

#p2
```

```{r}
top_row <- plot_grid(p2,p1, labels = c("A","B"),rel_widths = c(2,1))
```  
  
## **C. MDS diet effect**    
  
```{r}
h2 = 0.25
b2 = 0.25
noise = 0.6
effect.size = 0.3
dir= T
center_bg = T
n_ind = 500
lambda = 0.5

set.seed(56)
# Xi <- small portions of individuals
diet <- rep(0, n_ind)
diet_ind <- sample(1:n_ind, 250)
diet[diet_ind] <- 1 
X <- matrix(diet, ncol = n_ind, nrow = 1)

# theta <- all taxa, big size effect with negative values
theta <- rep(0, length(taxa_assign_g))
cluster_diet <- table(taxa_assign_g)[table(taxa_assign_g) > 10 & table(taxa_assign_g) < 30] %>% sample(3) %>% names() %>% as.numeric() #sample of clusters modulated by diet
theta[taxa_assign_g %in% cluster_diet] <- rnorm(sum(taxa_assign_g %in% cluster_diet ),mean = 0, sd = 2)
theta <- ifelse(theta < 0, -theta, theta) %>% matrix(ncol = 1, nrow = length(taxa_assign_g))#Only positive values for all taxa

thetaX <- theta %*% X

generations_simu_env <- holo_simu(h2 = h2,
                              b2 = b2,
                              founder_object = founder_object,
                              n_clust = taxa_assign_g,
                              n_ind = n_ind,
                              verbose = F,
                              noise.microbiome = noise,
                              effect.size = effect.size,
                              lambda = lambda,
                              dir = dir,
                              selection = F,
                              seed = 3042,
                              thetaX = thetaX,
                              env_gen = c(T,T,T,T,T))
```

```{r}
diversities_microbiomes <- generations_simu_env[c(2,3,4,5)] %>% map(get_microbiomes) %>% map(richness_from_abundances_gen) |> bind_rows(.id = "Generation")

  p4 <- ggplot(diversities_microbiomes,aes(x=Shannon,y=Generation,fill=Generation)) +
        geom_density_ridges(alpha=0.8) + 
        theme(legend.position = "none",
              panel.background = element_rect(fill="white"),
              panel.grid.major = element_line(colour="#e3e3e3"),
              panel.grid.minor = element_line(colour="#e9e9e9"),
              axis.title = element_text(size = 8),
              axis.text = element_text(size=7),
              plot.title = element_text(size=12),
              aspect.ratio = 1.5)+
        scale_fill_manual(values = rev(greens_pal)[1:4])
  # p4
  
```
  
## **D. Diversity diet effect**    
 
```{r}
microbiomes_all <- generations_simu_env[c(2,3,4,5)] %>% map(get_microbiomes, transpose = T, CLR = F) |> bind_rows(.id = "Generation")

diet_vec <- rep(0, nrow(microbiomes_all))
diet_vec[which(microbiomes_all$Generation == "G1")[diet_ind]] <- 1
diet_vec[which(microbiomes_all$Generation == "G2")[diet_ind]] <- 1
diet_vec[which(microbiomes_all$Generation == "G3")[diet_ind]] <- 1
diet_vec[which(microbiomes_all$Generation == "G4")[diet_ind]] <- 1
diet_vec[which(microbiomes_all$Generation == "G5")[diet_ind]] <- 1

metadata <- cbind(Generation = microbiomes_all$Generation, ID = rownames(microbiomes_all), diet = diet_vec) |> as.data.frame()
rownames(metadata) <- metadata$ID

dist_mat <- vegan::vegdist(x = microbiomes_all[-1],
                 method = "bray")


physeq <- phyloseq(
  otu_table(t(microbiomes_all[,-1]), taxa_are_rows = TRUE),
  sample_data(metadata))

ord <- ordinate(physeq, method = "MDS", distance = dist_mat)

DF <- plot_ordination(physeq, ord, justDF = T)
p3 <- ggplot(data = DF, aes(x=DF[,1], y=DF[,2], color = diet, shape=diet)) + 
    labs(x = "Axis 1",
         y = "Axis 2") +
  geom_point(alpha = 0.8) + 
  theme(panel.background = element_rect(fill="white"),
            panel.grid.major = element_line(colour="#e3e3e3"),
            panel.grid.minor = element_line(colour="#e9e9e9"),
            axis.title = element_text(size = 8),
            axis.text = element_text(size=7),
            plot.title = element_text(size=7),
            legend.key.size = unit(0.25, 'cm'), #change legend key size
            legend.title = element_text(size=7), #change legend title font size
            legend.text = element_text(size=7),
            strip.text = element_text(color = "white", face = "bold")) +#change legend text font size) 
  facet_wrap2(~Generation, nrow = 2, ncol = 2, strip = strip_themed(background_x = elem_list_rect(fill = rev(greens_pal)[1:4]))) +
  scale_fill_manual(values = rev(greens_pal)[1:4])
#p3
```

```{r}
bottom_row <- plot_grid(p3,p4, labels = c("C","D"),rel_widths = c(2,1))
```
  
## **Global**  
  
```{r}
plot_grid(top_row,bottom_row,nrow = 2)
```   
  
# **Fig 5. Phenotypes**
  
## **A. Consistant values of direct heritability and microbiability across generation**  
  
```{r}
# n_it = 50 was used to generate the figures of the article
n_it = 1
set.seed(42)
vec_seed <- sample(100:10000,n_it)
```

```{r}
noise = 0.6
effect.size = 0.3
lambda = 0.1
dir = T

params_df_it <- tibble::tribble(
  ~h2,  ~b2,
  0.05, 0.05,
  0.25, 0.05,
  0.4,  0.05,
  0.05, 0.25,
  0.25, 0.25,
  0.4,  0.25,
  0.05, 0.4,
  0.25, 0.4,
  0.4,  0.4
  ) |> crossing(tibble(`Selection Type` = c("GB", "G", "B", "None")),tibble(seed = vec_seed)) |> 
  mutate(sim_ID = row_number(), .before = "h2")
params_df <- tibble::tribble(
  ~h2,  ~b2,
  0.05, 0.05,
  0.25, 0.05,
  0.4,  0.05,
  0.05, 0.25,
  0.25, 0.25,
  0.4,  0.25,
  0.05, 0.4,
  0.25, 0.4,
  0.4,  0.4
) |> 
  crossing(tibble(`Selection Type` = c("GB", "G", "B", "Random"))) |> 
  mutate(sim_ID = row_number(), .before = "h2")
```
  
```{r}
# log_file <- "execution_log.tsv"
# summary_file <- "execution_summary.txt"
# cat("Simulation_ID","\t","Iteration","\t","Execution_Time_sec","\t","Peak_RAM_MiB","\n", file = log_file)

# output_dir <- "simulation_results"
# dir.create(output_dir, showWarnings = FALSE)


# run_simulation <- function(i, it) {
#   start_time_it <- Sys.time()
#   
#   ram_result <- peakRAM({
#   taxa_assign_g <- assign_taxa(founder_object)
#   
#   generations_simu <- holo_simu(
#     h2 = params_df$h2[i],
#     b2 = params_df$b2[i],
#     founder_object = founder_object,
#     n_clust = taxa_assign_g,
#     n_ind = 500,
#     verbose = FALSE,
#     noise.microbiome = noise,
#     effect.size = effect.size,
#     lambda = lambda,
#     dir = dir,
#     selection = if (params_df$`Selection Type`[i] == "Random") FALSE else TRUE,
#     size_selection_F = 0.3,
#     size_selection_M = 0.3,
#     selection_type = if (params_df$`Selection Type`[i] == "Random") NULL else params_df$`Selection Type`[i],
#     seed = vec_seed[it]
#   )
#   })
#   
#   # end_time_it <- Sys.time()
#   # exec_time <- round(difftime(end_time_it, start_time_it, units = "secs"), 2)
#   # peak_ram <- round(ram_result$Peak_RAM_Used_MiB, 2)
#   # 
#   # cat(glue("{i}\t{it}\t{exec_time}\t{peak_ram}"),"\n", file = log_file, append = TRUE)
#   
#   gc() #clean memory
#   
# 
#   tibble(mean_phenotypes = list(generations_simu[-1] %>% map(get_mean_phenotypes)),
#        gq = list(generations_simu[-1] %>% map(get_phenotypes_value,"gq")),
#        gb = list(generations_simu[-1] %>% map(get_phenotypes_value,"gb")),
#        beta = list(generations_simu[-1] %>% map(get_om_beta_g)),
#        ID_selected = list(generations_simu[-1] %>% map(get_selected_ind))
#   )
#   
#   
#   
# }
# 
# 
# start_time <- Sys.time()
# plan(sequential)
# plan(multisession, workers = 3)
# results <- future_map_dfr(
#   seq_len(nrow(params_df)), 
#   function(i) {
#     map_dfr(seq_len(n_it), ~ run_simulation(i, .x))
#   }
# )
# # end_time <- Sys.time()
# # 
# # log_data <- read.delim(log_file, sep = "\t")
# # max_peak_ram <- max(log_data$Peak_RAM_MiB, na.rm = TRUE)
# # 
# # cat(glue(
# #   "Summary:\n",
# #   "Execution started at: {start_time}\n",
# #   "Execution ended at: {end_time}\n",
# #   "Total execution time: {round(difftime(end_time, start_time, units = 'mins'), 2)} minutes\n",
# #   "Maximum Peak RAM Used: {max_peak_ram} MiB\n"
# # ), file = summary_file)
# 
# plan(sequential)
```
## **B. Selection Mode**  
  
# **Case study**
