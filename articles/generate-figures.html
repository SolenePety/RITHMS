<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generate figures • RITHMS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate figures">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RITHMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/generate-figures.html">Generate figures</a></li>
    <li><a class="dropdown-item" href="../articles/import-data.html">Data Importation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SolenePety/RITHMS"><span class="fa fab fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generate figures</h1>
            
      

      <div class="d-none name"><code>generate-figures.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RITHMS</span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/generate-figures.Rmd: do not edit by hand -->
<p>In this vignette, we explore a large number of simulation scenarios
to illustrate the capabilities and features of RITHMS. These results
were obtained on the dataset described below. Further explanations are
given in <a href="https://arxiv.org/abs/2502.07366" class="external-link">the article</a>.
RITHMS can account for a variety of <strong>selection
strategies</strong> and is adaptable to different genetic architectures.
We found that simulated data accurately preserved key characteristics
<strong>across generations</strong>, notably <strong>microbial diversity
metrics</strong>, exhibited the expected behavior in terms and
<strong>correlation</strong> between taxa and of modulation of
<strong>vertical and horizontal transmission</strong>, response to
<strong>environmental effects</strong> and the evolution of
<strong>phenotypic values</strong> depending on selection strategy.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MoBPS</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize" class="external-link">circlize</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggridges/" class="external-link">ggridges</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://dx.plos.org/10.1371/journal.pone.0061217" class="external-link">phyloseq</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/teunbrand/ggh4x" class="external-link">ggh4x</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/tpq/peakRAM" class="external-link">peakRAM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span></code></pre></div>
<p>To visualise changes over generations, we will use a green gradient
:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">greens_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#6df17c"</span>,<span class="st">"#2ede41"</span>,<span class="st">"#26c537"</span>,<span class="st">"#1da42c"</span>,<span class="st">"#157e21"</span>,<span class="st">"#0E5e17"</span><span class="op">)</span></span></code></pre></div>
<p>General theme parameters for plots :</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session_theme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour<span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>                                               panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#e3e3e3"</span><span class="op">)</span>,</span>
<span>                                               panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"#e9e9e9"</span><span class="op">)</span>,</span>
<span>                                               axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>                                               axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>                                               plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>                                               legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                                               legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                                               legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="va">session_theme</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="load-data">
<strong>Load data</strong><a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>The data matrix loaded is the count matrix of taxa (in columns)
across individuals (in rows). In our toy dataset, a subset from <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC7538339/" class="external-link">Déru et
al. 2020</a>, there are <strong>1845 species</strong> and <strong>780
individuals</strong> coming from the conventional diet. Genotypes are
encoded as 0,1,2 and reachable thanks to <em>“population”</em>
attribute.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"Deru"</span><span class="op">)</span></span>
<span><span class="va">founder_object</span> <span class="op">&lt;-</span> <span class="va">Deru</span></span>
<span><span class="va">founder_object</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;   OTU1 OTU2 OTU6793 OTU3 OTU4</span></span>
<span><span class="co">#&gt; 1   30  593       4  630  414</span></span>
<span><span class="co">#&gt; 2  254  275      62 1131  446</span></span>
<span><span class="co">#&gt; 3  181  487     164 1472  656</span></span>
<span><span class="co">#&gt; 4  469  665      45  640  328</span></span>
<span><span class="co">#&gt; 5  771  519      21  758  347</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#MoBPS population structure, use get.geno() and generation index to extract genotypes</span></span>
<span><span class="va">genotypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">founder_object</span>, <span class="st">"population"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/MoBPS/man/get.geno.html" class="external-link">get.geno</a></span><span class="op">(</span>gen<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">genotypes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;      M1_1 M2_1 M3_1 M4_1 M5_1</span></span>
<span><span class="co">#&gt; SNP1    2    2    1    1    2</span></span>
<span><span class="co">#&gt; SNP2    1    1    1    1    1</span></span>
<span><span class="co">#&gt; SNP3    2    2    2    2    2</span></span>
<span><span class="co">#&gt; SNP4    2    2    2    2    2</span></span>
<span><span class="co">#&gt; SNP5    2    2    1    1    2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulation-reflects-structure-of-microbiome">
<strong>Simulation reflects structure of microbiome</strong><a class="anchor" aria-label="anchor" href="#simulation-reflects-structure-of-microbiome"></a>
</h2>
<p>This section matches code of <strong>Figure 3</strong> of the
paper.</p>
<div class="section level3">
<h3 id="produce-intra--and-inter-cluster-anticorrelations">
<strong>Produce intra- and inter-cluster
(anti)correlations</strong><a class="anchor" aria-label="anchor" href="#produce-intra--and-inter-cluster-anticorrelations"></a>
</h3>
<p>Through
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
matrix, its values and the overlapping of QTL, we’re able to induce
correlations between taxa.</p>
<p>For this example, <strong>4%</strong> of the taxa are under genetic
control. The pairwise correlation matrix of taxa abundances are
represented here. Taxa are sorted based on the cluster they belong
to.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxa_assign_g_small</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/formatting_data.html">assign_taxa</a></span><span class="op">(</span><span class="va">founder_object</span>, </span>
<span>                                   taxa_g <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Output is the assignation of each taxa to a cluster, 0 corresponds to taxa that are not under genetic control</span></span>
<span><span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span><span class="fl">0</span> <span class="op">]</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 2 1 1 2 1 3 4 3 4 3 2 2 2 4 3 2 5 2 2 2 4 3 3 2 3 4 3 3 1 6 6 1 6 4 4</span></span>
<span><span class="co">#&gt; [39] 6 1 5 5 1 5 4 4 1 5 3 3 4 2 6 4 6 5 5 4 6 6 6 2 3 5 1 5 5 5 5 5 6 6 4 4 4 5</span></span>
<span><span class="co">#&gt; [77] 4 3 6</span></span>
<span><span class="co">#&gt; Levels: 0 1 2 3 4 5 6</span></span></code></pre></div>
<p>Once you have these elements you’re able to call
<code><a href="../reference/holo_simu.html">holo_simu()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.6</span> <span class="co">#noise of the microbiome</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.3</span> <span class="co">#genetic effect size</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">0.5</span> <span class="co">#same weight for vertical and horizontal transmission</span></span>
<span><span class="va">dir</span> <span class="op">=</span> <span class="cn">T</span> <span class="co">#dirichlet sampling for ambient microbiome</span></span>
<span></span>
<span><span class="va">generations_simu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="fl">0.25</span>, <span class="co">#direct heritability</span></span>
<span>                              b2 <span class="op">=</span> <span class="fl">0.25</span>, <span class="co">#microbiability</span></span>
<span>                              founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                              n_clust <span class="op">=</span> <span class="va">taxa_assign_g_small</span>,</span>
<span>                              n_ind <span class="op">=</span> <span class="fl">500</span>, <span class="co">#per generation</span></span>
<span>                              verbose <span class="op">=</span> <span class="cn">F</span>, </span>
<span>                              noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                              effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                              lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>                              dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>                              selection <span class="op">=</span> <span class="cn">F</span>, <span class="co">#30% males and females sampled for next generation</span></span>
<span>                              seed <span class="op">=</span> <span class="fl">333</span><span class="op">)</span></span></code></pre></div>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
matrix is reachable through metadata of <code><a href="../reference/holo_simu.html">holo_simu()</a></code>
output.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Correlation intra-cluster for cluster under genetic control</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">generations_simu</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">Beta_matrix</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span>,<span class="op">]</span></span>
<span><span class="va">cor_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">taxa_order</span> <span class="op">&lt;-</span> <span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cor_matrix</span> <span class="op">&lt;-</span> <span class="va">cor_matrix</span><span class="op">[</span><span class="va">taxa_order</span>,<span class="va">taxa_order</span><span class="op">]</span></span></code></pre></div>
<p>Then we’re able to build our Heatmap using <a href="https://jokergoo.github.io/ComplexHeatmap-reference/book/" class="external-link">ComplexHeatmap</a></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="fl">5</span>,<span class="st">"Set1"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clus_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span><span class="va">pal</span>, names <span class="op">=</span> <span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">leftAnn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/rowAnnotation.html" class="external-link">rowAnnotation</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">clus_col</span><span class="op">)</span>,</span>
<span>                        show_annotation_name <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                        annotation_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Cluster ID"</span>,title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">5</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, labels_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">5</span>, fontface <span class="op">=</span> <span class="st">'bold'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">colAnn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/HeatmapAnnotation.html" class="external-link">HeatmapAnnotation</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">taxa_assign_g_small</span><span class="op">[</span><span class="va">taxa_assign_g_small</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                        col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">clus_col</span><span class="op">)</span>,</span>
<span>                        show_annotation_name <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                        show_legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_fun</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html" class="external-link">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">cor_matrix</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cor_matrix</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.grab.html" class="external-link">grid.grabExpr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">cor_matrix</span>, </span>
<span>        cluster_rows <span class="op">=</span> <span class="cn">F</span>, </span>
<span>        cluster_columns <span class="op">=</span> <span class="cn">F</span>, </span>
<span>        show_row_names <span class="op">=</span> <span class="cn">F</span>, </span>
<span>        show_column_names <span class="op">=</span> <span class="cn">F</span>,</span>
<span>        left_annotation <span class="op">=</span> <span class="va">leftAnn</span>,</span>
<span>        top_annotation <span class="op">=</span> <span class="va">colAnn</span>,</span>
<span>        col <span class="op">=</span> <span class="va">col_fun</span>,</span>
<span>        heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation"</span>, title_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">5</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, labels_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">5</span>, fontface <span class="op">=</span> <span class="st">'bold'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/Heatmap_correlation.png" style="width:80.0%"></p>
</div>
<div class="section level3">
<h3 id="modulate-relative-importance-of-vertical-and-horizontal-transmission">
<strong>Modulate relative importance of vertical and horizontal
transmission</strong><a class="anchor" aria-label="anchor" href="#modulate-relative-importance-of-vertical-and-horizontal-transmission"></a>
</h3>
<p>The composition of the microbiota of individuals are given by this
equation :
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><msubsup><mi>𝐌</mi><mrow><mi>d</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>λ</mi><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mi>𝐌</mi><mrow><mi>a</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\lambda \boldsymbol{M}^{(t-1)}_{d(i)} + (1 - \lambda) \boldsymbol{M}^{(t)}_{a(i)}</annotation></semantics></math>.
Given this,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\lambda = 0</annotation></semantics></math>
corresponds to no vertical transmission. We’re looking here at the
correlations between offspring α-diversity (from G2) and that of its
mother (purple), father (orange) or ambient microbiota (green) for
increasing values of λ.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">484</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Change n_it to increase the accuracy of the function, n_it = 10 used in the article</span></span>
<span><span class="va">n_it</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="va">seed_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">9999</span><span class="op">)</span>,<span class="va">n_it</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params_df_it</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="va">seed_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim_ID <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span></code></pre></div>
<p>We perform the taxa assignation for all this small study.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">taxa_assign_g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/formatting_data.html">assign_taxa</a></span><span class="op">(</span><span class="va">founder_object</span><span class="op">)</span></span></code></pre></div>
<p>Then we have the following function that can be call in parallel for
all the different scnarios in this test.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">center_bg</span> <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">dir</span> <span class="op">=</span> <span class="cn">T</span></span>
<span></span>
<span><span class="co">#Boxplot lambda vs diversity correlation with offspring</span></span>
<span>  </span>
<span><span class="va">run_simulation_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">it</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">generations_simu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                                    b2 <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                                    founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                                    n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                                    n_ind <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                    verbose <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                                    noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                                    effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                                    lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">[</span><span class="va">i</span>,<span class="st">"lambda"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                    dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>                                    selection <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                                    seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">[</span><span class="va">i</span>,<span class="st">"seed"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">#Richness of G2 offsprings</span></span>
<span>      <span class="va">current_div</span> <span class="op">&lt;-</span> <span class="va">generations_simu</span><span class="op">$</span><span class="va">G2</span><span class="op">$</span><span class="va">microbiome</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">#Richness of offpsring's fathers</span></span>
<span>      <span class="va">previous_s_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">generations_simu</span><span class="op">$</span><span class="va">G2</span><span class="op">$</span><span class="va">pedigree</span><span class="op">[</span>,<span class="st">"father"</span><span class="op">]</span>,</span>
<span>                               <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">generations_simu</span><span class="op">$</span><span class="va">G1</span><span class="op">$</span><span class="va">microbiome</span><span class="op">[</span>,<span class="va">x</span><span class="op">]</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">#Richness of offpsring's mothers</span></span>
<span>      <span class="va">previous_d_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">generations_simu</span><span class="op">$</span><span class="va">G2</span><span class="op">$</span><span class="va">pedigree</span><span class="op">[</span>,<span class="st">"mother"</span><span class="op">]</span>,</span>
<span>                               <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">generations_simu</span><span class="op">$</span><span class="va">G1</span><span class="op">$</span><span class="va">microbiome</span><span class="op">[</span>,<span class="va">x</span><span class="op">]</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co">#Richness of ambient microbiome</span></span>
<span>      <span class="va">ambient_div</span> <span class="op">&lt;-</span> <span class="va">generations_simu</span><span class="op">$</span><span class="va">G2</span><span class="op">$</span><span class="va">mean_microbiome</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      </span>
<span>      </span>
<span>      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">[</span><span class="va">i</span>,<span class="st">"lambda"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             Mother <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">current_div</span><span class="op">$</span><span class="va">Shannon</span>,<span class="va">previous_d_div</span><span class="op">$</span><span class="va">Shannon</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             Father <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">current_div</span><span class="op">$</span><span class="va">Shannon</span>,<span class="va">previous_s_div</span><span class="op">$</span><span class="va">Shannon</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             Ambient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">current_div</span><span class="op">$</span><span class="va">Shannon</span>,<span class="va">ambient_div</span><span class="op">$</span><span class="va">Shannon</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span> </span></code></pre></div>
<p>If you want to parallelize the code, you could use
<code>plan(multisession)</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">future_map_dfr</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_it</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">run_simulation_lambda</span><span class="op">(</span><span class="va">i</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>The useful information of these simulations are the microbiomes, the
pedigree and the ambient microbiome that could be extracted for each
generation. We’re focusing on G2 here.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_cor_gen</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>,</span>
<span>         Mother <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">Mother</span><span class="op">)</span>,</span>
<span>         Father <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">Father</span><span class="op">)</span>,</span>
<span>         Ambient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">Ambient</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Mother"</span>,<span class="st">"Father"</span>,<span class="st">"Ambient"</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"cor_type"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lambda_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>,<span class="fl">0.2</span>,<span class="fl">0.8</span><span class="op">)</span>,</span>
<span>                      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ambient"</span>,<span class="st">"Father"</span>,<span class="st">"Mother"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lambda_label</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">lambda_label</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">long_cor_gen</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="va">cor_type</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>,y<span class="op">=</span><span class="va">value</span>,col<span class="op">=</span><span class="va">cor_type</span>, group <span class="op">=</span> <span class="va">cor_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lambda_label</span>,</span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, label <span class="op">=</span> <span class="va">label</span>, color <span class="op">=</span> <span class="va">label</span>, group <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>        direction <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Correlation value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Lambda"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"Parents"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.25</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span></span></code></pre></div>
<p><img src="../reference/figures/lambda_correlation.png" style="width:80.0%"></p>
</div>
<div class="section level3">
<h3 id="achieve-a-target-distribution-of-taxa-heritabilities">
<strong>Achieve a target distribution of taxa
heritabilities</strong><a class="anchor" aria-label="anchor" href="#achieve-a-target-distribution-of-taxa-heritabilities"></a>
</h3>
<p>The function <code>calibrate_gen_effect()</code> is intended to guide
the user in choosing an appropriate effect size to achieve a target
distribution of taxa heritabilities. Build-in plots are in the function
but we’ve used the output of the function in order to make a density
plot of the distribution of taxa heritability for increasing genetic
effect sizes
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mi>β</mi></msub><mo>×</mo><msqrt><msub><mtext mathvariant="normal">QTL</mtext><mtext mathvariant="normal">o</mtext></msub></msqrt></mrow><annotation encoding="application/x-tex">\sigma_{\beta}\times\sqrt{\text{QTL}_\text{o}}</annotation></semantics></math>),
shown above each curve.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gen_effect_calibration.html">gen_effect_calibration</a></span><span class="op">(</span>founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                                   taxa_assign_g <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                                   correlation <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                                   effect.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>,<span class="fl">0.6</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>                                   plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate density peaks</span></span>
<span><span class="va">density_peaks</span> <span class="op">&lt;-</span> <span class="va">out_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">effect.size</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    peak <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">Heritability</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">Heritability</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    peak_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">Heritability</span><span class="op">)</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">Heritability</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">out_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Heritability</span>,fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">effect.size</span><span class="op">)</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">effect.size</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.8</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">density_peaks</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">peak_x</span>, y <span class="op">=</span> <span class="va">peak</span>, label <span class="op">=</span> <span class="va">effect.size</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">effect.size</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        nudge_x <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>        nudge_y <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>        direction <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Taxa heritability"</span>,</span>
<span>           y <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>           fill <span class="op">=</span> <span class="st">"Genetic effect size"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"white"</span><span class="op">)</span>,</span>
<span>            panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"#e3e3e3"</span><span class="op">)</span>,</span>
<span>            panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"#e9e9e9"</span><span class="op">)</span>,</span>
<span>            axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>            axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>            plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>            legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#00AFBB"</span>, <span class="st">"#E7B800"</span>, <span class="st">"#FC4E07"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#00AFBB"</span>, <span class="st">"#E7B800"</span>, <span class="st">"#FC4E07"</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="va">p2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="alpha-diversity-remains-stable-across-generations">
<strong>Alpha-diversity remains stable across
generations</strong><a class="anchor" aria-label="anchor" href="#alpha-diversity-remains-stable-across-generations"></a>
</h3>
<p>In a neutral framework, without selection of environmental effect, we
expect the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>-diversity
to be stable across generations. From <code><a href="../reference/holo_simu.html">holo_simu()</a></code> output,
the relative abundances of taxa,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>-diversity
indexes thanks to multinomial sampling in
<code><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen()</a></code> function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">b2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">generations_simu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="va">h2</span>,</span>
<span>                              b2 <span class="op">=</span> <span class="va">b2</span>,</span>
<span>                              founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                              n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                              n_ind <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                              verbose <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                              noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                              effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                              lambda <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                              dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>                              selection <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                              seed <span class="op">=</span> <span class="fl">8082</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diversities_microbiomes</span> <span class="op">&lt;-</span> <span class="va">generations_simu</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">richness_from_abundances_gen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span>  <span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">diversities_microbiomes</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Shannon</span>,y<span class="op">=</span><span class="va">Generation</span>,fill<span class="op">=</span><span class="va">Generation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html" class="external-link">geom_density_ridges</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">p4</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="st">"../man/figures/ridges_shannon.png"</span>, <span class="va">p4</span>, width <span class="op">=</span> <span class="fl">9</span>, height <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/ridges_shannon.png" style="width:80.0%"></p>
</div>
</div>
<div class="section level2">
<h2 id="introduction-of-transient-perturbations-of-the-microbiota">
<strong>Introduction of transient perturbations of the
microbiota</strong><a class="anchor" aria-label="anchor" href="#introduction-of-transient-perturbations-of-the-microbiota"></a>
</h2>
<p>In breeding and selection programs, it is essential to account for
fixed environmental effects, given their strong role in modulating an
individual’s phenotype. It is therefore important to verify that
simulated transgenerational hologenomic data can correctly integrate
such factors under a variety of plausible scenarios, such as short-term
treatments or long-term diet effects.</p>
<p>To build this modulation, the user build outside the main function
the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi><mi>X</mi></mrow><annotation encoding="application/x-tex">\theta X</annotation></semantics></math>
product and choose precisely the values and the effect size given to
each environmental effect. Dimensions of this product should match the
<code>founder_object</code> ones.</p>
<p>To evaluate our simulation on that part we’ve computed a
multidimensional scaling (MDS) of microbial abundance data using
Bray-Curtis distances and ridges plot of Shannon index values.</p>
<p>This section matches code of <strong>Figure 4</strong> of the
paper.</p>
<div class="section level3">
<h3 id="sporadic-environmental-effect">
<strong>Sporadic environmental effect</strong><a class="anchor" aria-label="anchor" href="#sporadic-environmental-effect"></a>
</h3>
<p>Half the individuals at G1 are subject to a sporadic antibiotic
treatment which affects all taxa.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Construction of environmental effect before simulating the population</span></span>
<span><span class="va">h2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">b2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span><span class="va">dir</span><span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">n_ind</span> <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">antibio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_ind</span><span class="op">)</span></span>
<span><span class="va">antibio_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_ind</span>, <span class="fl">250</span><span class="op">)</span> <span class="co">#selecting index of individuals</span></span>
<span><span class="va">antibio</span><span class="op">[</span><span class="va">antibio_ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> </span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">antibio</span>, ncol <span class="op">=</span> <span class="va">n_ind</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">founder_object</span><span class="op">)</span>,mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="co">#sampling strong antibiotics effect</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">theta</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="op">-</span><span class="va">theta</span>, <span class="va">theta</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">founder_object</span><span class="op">)</span><span class="op">)</span> <span class="co">#only negative values for all taxa</span></span>
<span></span>
<span><span class="va">thetaX</span> <span class="op">&lt;-</span> <span class="va">theta</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generations_simu_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="va">h2</span>,</span>
<span>                                  b2 <span class="op">=</span> <span class="va">b2</span>,</span>
<span>                                  founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                                  n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                                  n_ind <span class="op">=</span> <span class="va">n_ind</span>,</span>
<span>                                  verbose <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                                  noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                                  effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                                  lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>                                  dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>                                  selection <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                                  seed <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                                  thetaX <span class="op">=</span> <span class="va">thetaX</span>,</span>
<span>                                  env_gen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">T</span>,<span class="cn">F</span>,<span class="cn">F</span>,<span class="cn">F</span>,<span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="co">#on the five generations asked, we apply thetaX only on G1, not considering G0</span></span></code></pre></div>
<div class="section level4">
<h4 id="diversity-on-antibiotic-effect">
<strong>Diversity on antibiotic effect</strong><a class="anchor" aria-label="anchor" href="#diversity-on-antibiotic-effect"></a>
</h4>
<p>Call to <code><a href="../reference/get_microbiomes.html">get_microbiomes()</a></code> and
<code><a href="../reference/richness_from_abundances_gen.html">richness_from_abundances_gen()</a></code> to extract all useful
metrics.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diversities_microbiomes</span> <span class="op">&lt;-</span> <span class="va">generations_simu_env</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">richness_from_abundances_gen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">diversities_microbiomes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">Generation</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G4"</span>,<span class="st">"G5"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Shannon</span>,y<span class="op">=</span><span class="va">Generation</span>,fill<span class="op">=</span><span class="va">Generation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html" class="external-link">geom_density_ridges</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p1</span></span></code></pre></div>
<p><img src="../reference/figures/antibio_shannon.png" style="width:80.0%"></p>
</div>
<div class="section level4">
<h4 id="mds-on-antibiotic-effect">
<strong>MDS on antibiotic effect</strong><a class="anchor" aria-label="anchor" href="#mds-on-antibiotic-effect"></a>
</h4>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">microbiomes_all</span> <span class="op">&lt;-</span> <span class="va">generations_simu_env</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span>, transpose <span class="op">=</span> <span class="cn">T</span>, CLR <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span>                          </span>
<span><span class="va">antibio_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">id_antibio_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G1"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="op">(</span><span class="va">generations_simu_env</span><span class="op">$</span><span class="va">G1</span><span class="op">$</span><span class="va">microbiome</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">antibio_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G1"</span><span class="op">)</span><span class="op">[</span><span class="va">id_antibio_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Generation <span class="op">=</span> <span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span>, ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">)</span>, antibio <span class="op">=</span> <span class="va">antibio_vec</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">$</span><span class="va">ID</span></span></code></pre></div>
<p>Call to <a href="https://cran.r-project.org/web/packages/vegan/vignettes/intro-vegan.pdf" class="external-link">vegan
package</a> to compute Bray Curtis distance matrix.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist_mat</span> <span class="op">&lt;-</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html" class="external-link">vegdist</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">microbiomes_all</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"bray"</span><span class="op">)</span></span></code></pre></div>
<p>Call to <a href="https://joey711.github.io/phyloseq/" class="external-link">phyloseq
package</a> to manipulate efficiently and compute MDS with
<code><a href="https://rdrr.io/pkg/phyloseq/man/ordinate.html" class="external-link">ordinate()</a></code> function.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">physeq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/phyloseq.html" class="external-link">phyloseq</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/otu_table-methods.html" class="external-link">otu_table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, taxa_are_rows <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html" class="external-link">sample_data</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/ordinate.html" class="external-link">ordinate</a></span><span class="op">(</span><span class="va">physeq</span>, method <span class="op">=</span> <span class="st">"MDS"</span>, distance <span class="op">=</span> <span class="va">dist_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/plot_ordination.html" class="external-link">plot_ordination</a></span><span class="op">(</span><span class="va">physeq</span>, <span class="va">ord</span>, justDF <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">DF</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">DF</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y<span class="op">=</span><span class="va">DF</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, color <span class="op">=</span> <span class="va">antibio</span>, shape<span class="op">=</span><span class="va">antibio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Axis 1"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Axis 2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/facet_wrap2.html" class="external-link">facet_wrap2</a></span><span class="op">(</span><span class="op">~</span><span class="va">Generation</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/strip_themed.html" class="external-link">strip_themed</a></span><span class="op">(</span>background_x <span class="op">=</span> <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/distribute_args.html" class="external-link">elem_list_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span></span></code></pre></div>
<p><img src="../reference/figures/mds_antibio.png" style="width:80.0%"></p>
</div>
</div>
<div class="section level3">
<h3 id="sustained-environmental-effet">
<strong>Sustained environmental effet</strong><a class="anchor" aria-label="anchor" href="#sustained-environmental-effet"></a>
</h3>
<p>Starting from G1, half the individuals at each generation (blue
triangles) are subject to a diet favoring two clusters of taxa.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">b2</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span><span class="va">dir</span><span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">center_bg</span> <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="va">n_ind</span> <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">56</span><span class="op">)</span></span>
<span><span class="co"># Xi &lt;- small portions of individuals</span></span>
<span><span class="va">diet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_ind</span><span class="op">)</span></span>
<span><span class="va">diet_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_ind</span>, <span class="fl">250</span><span class="op">)</span></span>
<span><span class="va">diet</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> </span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">diet</span>, ncol <span class="op">=</span> <span class="va">n_ind</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa_assign_g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cluster_diet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">taxa_assign_g</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">taxa_assign_g</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">taxa_assign_g</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#sample of clusters modulated by diet</span></span>
<span><span class="va">theta</span><span class="op">[</span><span class="va">taxa_assign_g</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cluster_diet</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">taxa_assign_g</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cluster_diet</span> <span class="op">)</span>,mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">theta</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="op">-</span><span class="va">theta</span>, <span class="va">theta</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">1</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa_assign_g</span><span class="op">)</span><span class="op">)</span><span class="co">#Only positive values for all taxa</span></span>
<span></span>
<span><span class="va">thetaX</span> <span class="op">&lt;-</span> <span class="va">theta</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">X</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generations_simu_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="va">h2</span>,</span>
<span>                              b2 <span class="op">=</span> <span class="va">b2</span>,</span>
<span>                              founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                              n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                              n_ind <span class="op">=</span> <span class="va">n_ind</span>,</span>
<span>                              verbose <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                              noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                              effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                              lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>                              dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>                              selection <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                              seed <span class="op">=</span> <span class="fl">3042</span>,</span>
<span>                              thetaX <span class="op">=</span> <span class="va">thetaX</span>,</span>
<span>                              env_gen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">T</span>,<span class="cn">T</span>,<span class="cn">T</span>,<span class="cn">T</span>,<span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="co">#Applied on all generations </span></span></code></pre></div>
<div class="section level4">
<h4 id="diversity-on-diet-effect">
<strong>Diversity on diet effect</strong><a class="anchor" aria-label="anchor" href="#diversity-on-diet-effect"></a>
</h4>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diversities_microbiomes</span> <span class="op">&lt;-</span> <span class="va">generations_simu_env</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">richness_from_abundances_gen</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">diversities_microbiomes</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Shannon</span>,y<span class="op">=</span><span class="va">Generation</span>,fill<span class="op">=</span><span class="va">Generation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html" class="external-link">geom_density_ridges</a></span><span class="op">(</span>alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">p4</span></span></code></pre></div>
<p><img src="../reference/figures/diet_shannon.png" style="width:80.0%"></p>
</div>
<div class="section level4">
<h4 id="mds-on-diet-effect">
<strong>MDS on diet effect</strong><a class="anchor" aria-label="anchor" href="#mds-on-diet-effect"></a>
</h4>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Post-processing of the data</span></span>
<span><span class="va">microbiomes_all</span> <span class="op">&lt;-</span> <span class="va">generations_simu_env</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span>, transpose <span class="op">=</span> <span class="cn">T</span>, CLR <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diet_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diet_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G1"</span><span class="op">)</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">diet_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G2"</span><span class="op">)</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">diet_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G3"</span><span class="op">)</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">diet_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G4"</span><span class="op">)</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">diet_vec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G5"</span><span class="op">)</span><span class="op">[</span><span class="va">diet_ind</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Generation <span class="op">=</span> <span class="va">microbiomes_all</span><span class="op">$</span><span class="va">Generation</span>, ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">)</span>, diet <span class="op">=</span> <span class="va">diet_vec</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">$</span><span class="va">ID</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dist_mat</span> <span class="op">&lt;-</span> <span class="fu">vegan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vegan/man/vegdist.html" class="external-link">vegdist</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">microbiomes_all</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"bray"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">physeq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/phyloseq.html" class="external-link">phyloseq</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/otu_table-methods.html" class="external-link">otu_table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">microbiomes_all</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, taxa_are_rows <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html" class="external-link">sample_data</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/ordinate.html" class="external-link">ordinate</a></span><span class="op">(</span><span class="va">physeq</span>, method <span class="op">=</span> <span class="st">"MDS"</span>, distance <span class="op">=</span> <span class="va">dist_mat</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/plot_ordination.html" class="external-link">plot_ordination</a></span><span class="op">(</span><span class="va">physeq</span>, <span class="va">ord</span>, justDF <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">DF</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">DF</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y<span class="op">=</span><span class="va">DF</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, color <span class="op">=</span> <span class="va">diet</span>, shape<span class="op">=</span><span class="va">diet</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Axis 1"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Axis 2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">'cm'</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/facet_wrap2.html" class="external-link">facet_wrap2</a></span><span class="op">(</span><span class="op">~</span><span class="va">Generation</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span>, strip <span class="op">=</span> <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/strip_themed.html" class="external-link">strip_themed</a></span><span class="op">(</span>background_x <span class="op">=</span> <span class="fu"><a href="https://teunbrand.github.io/ggh4x/reference/distribute_args.html" class="external-link">elem_list_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">greens_pal</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">p3</span></span></code></pre></div>
<p><img src="../reference/figures/mds_diet.png" style="width:80.0%"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="fine-selection-of-direct-heritability-microbiability-and-selection-schemes">
<strong>Fine selection of direct heritability, microbiability and
selection schemes</strong><a class="anchor" aria-label="anchor" href="#fine-selection-of-direct-heritability-microbiability-and-selection-schemes"></a>
</h2>
<p>In the absence of selection, we want to verify that the target values
are reached and maintained across generations and then observe trends in
phenotypic improvement as a function of four different selection
strategies.</p>
<p>All the computation for both plots in this section are performed at
the same time, the barplot is a subset of the facet grid.</p>
<p>This section matches code of <strong>Figure 5</strong> of the
paper.</p>
<div class="section level3">
<h3 id="target-values-of-direct-heritability-and-microbiability-are-reached-and-maintained">
<strong>Target values of direct heritability and microbiability are
reached and maintained</strong><a class="anchor" aria-label="anchor" href="#target-values-of-direct-heritability-and-microbiability-are-reached-and-maintained"></a>
</h3>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># n_it = 50 was used to generate the figures of the article</span></span>
<span><span class="va">n_it</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">vec_seed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">10000</span>,<span class="va">n_it</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="va">dir</span> <span class="op">=</span> <span class="cn">T</span></span>
<span>  </span>
<span><span class="co">#For the exemple, not all values were computed, you can uncomment all the lines to obtain the complete figure.</span></span>
<span><span class="va">params_df_it</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">h2</span>,  <span class="op">~</span><span class="va">b2</span>,</span>
<span><span class="co">#  0.05, 0.05,</span></span>
<span><span class="co">#  0.25, 0.05,</span></span>
<span><span class="co">#  0.4,  0.05,</span></span>
<span> <span class="co"># 0.05, 0.25,</span></span>
<span>  <span class="fl">0.25</span>, <span class="fl">0.25</span>,</span>
<span>  <span class="fl">0.4</span>,  <span class="fl">0.25</span>,</span>
<span><span class="co">#  0.05, 0.4,</span></span>
<span> <span class="fl">0.25</span>, <span class="fl">0.4</span>,</span>
<span>  <span class="fl">0.4</span>,  <span class="fl">0.4</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>`Selection Type` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GB"</span>, <span class="st">"G"</span>, <span class="st">"B"</span>, <span class="st">"None"</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="va">vec_seed</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim_ID <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="st">"h2"</span><span class="op">)</span></span>
<span><span class="va">params_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">h2</span>,  <span class="op">~</span><span class="va">b2</span>,</span>
<span> <span class="co"># 0.05, 0.05,</span></span>
<span> <span class="co"># 0.25, 0.05,</span></span>
<span><span class="co">#  0.4,  0.05,</span></span>
<span> <span class="co"># 0.05, 0.25,</span></span>
<span>  <span class="fl">0.25</span>, <span class="fl">0.25</span>,</span>
<span>  <span class="fl">0.4</span>,  <span class="fl">0.25</span>,</span>
<span><span class="co">#  0.05, 0.4,</span></span>
<span>  <span class="fl">0.25</span>, <span class="fl">0.4</span>,</span>
<span>  <span class="fl">0.4</span>,  <span class="fl">0.4</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>`Selection Type` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GB"</span>, <span class="st">"G"</span>, <span class="st">"B"</span>, <span class="st">"Random"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim_ID <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="st">"h2"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">it</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">start_time_it</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">ram_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/peakRAM/man/peakRAM.html" class="external-link">peakRAM</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">taxa_assign_g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/formatting_data.html">assign_taxa</a></span><span class="op">(</span><span class="va">founder_object</span><span class="op">)</span></span>
<span>    <span class="va">selection</span> <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">params_df</span><span class="op">$</span><span class="va">`Selection Type`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Random"</span><span class="op">)</span> <span class="cn">FALSE</span> <span class="kw">else</span> <span class="cn">TRUE</span></span>
<span>    <span class="va">generations_simu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span></span>
<span>      h2 <span class="op">=</span> <span class="va">params_df</span><span class="op">$</span><span class="va">h2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      b2 <span class="op">=</span> <span class="va">params_df</span><span class="op">$</span><span class="va">b2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>      n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>      n_ind <span class="op">=</span> <span class="fl">500</span>,</span>
<span>      verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>      effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>      lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>      dir <span class="op">=</span> <span class="va">dir</span>,</span>
<span>      selection <span class="op">=</span> <span class="va">selection</span>,</span>
<span>      size_selection_F <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">selection</span> <span class="op">==</span> <span class="st">"FALSE"</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fl">0.3</span>,</span>
<span>      size_selection_M <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">selection</span> <span class="op">==</span> <span class="st">"FALSE"</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="fl">0.3</span>,</span>
<span>      selection_type <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">params_df</span><span class="op">$</span><span class="va">`Selection Type`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Random"</span><span class="op">)</span> <span class="cn">NULL</span> <span class="kw">else</span> <span class="va">params_df</span><span class="op">$</span><span class="va">`Selection Type`</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      seed <span class="op">=</span> <span class="va">vec_seed</span><span class="op">[</span><span class="va">it</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#clean memory</span></span>
<span>  </span>
<span>  <span class="va">phenotypes_all</span> <span class="op">&lt;-</span> <span class="va">generations_simu</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_phenotypes</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>mean_phenotypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">generations_simu</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_mean_phenotypes</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         metric_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">phenotypes_all</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Generation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">gq</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                                          b2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">gb</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                                          e2 <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">gq</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">gb</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you want to parallelize the code, you could use
<code>plan(multisession)</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">future_map_dfr</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_it</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">run_simulation</span><span class="op">(</span><span class="va">i</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metrics_values</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">h2</span> <span class="op">==</span> <span class="fl">0.25</span>,<span class="va">b2</span> <span class="op">==</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">#for barplot, gather only results for h2 = b2 = 0.25</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">metric_values</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span><span class="va">metric_values</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_longer.html" class="external-link">unnest_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Generation</span>,<span class="va">h2</span>,<span class="va">b2</span>,<span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Generation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">h2</span><span class="op">)</span>, b2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">b2</span><span class="op">)</span>, e2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">h2</span>, <span class="va">b2</span>, <span class="va">e2</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"Metric"</span>, values_to <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metrics_values</span><span class="op">$</span><span class="va">Metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">metrics_values</span><span class="op">$</span><span class="va">Metric</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"e2"</span>,<span class="st">"b2"</span>,<span class="st">"h2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#ce0104"</span>, <span class="st">"#0237AE"</span>, <span class="st">"#808080"</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b2"</span>, <span class="st">"h2"</span>, <span class="st">"e2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">metrics_values</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Generation</span>, y <span class="op">=</span> <span class="va">Value</span>, fill <span class="op">=</span> <span class="va">Metric</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Value"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>vjust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.25</span>, col<span class="op">=</span><span class="st">"white"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">3</span>, y<span class="op">=</span> <span class="fl">0.125</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="va">h</span><span class="op">[</span><span class="va">d</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.5</span>, col<span class="op">=</span><span class="st">"white"</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">3</span>, y<span class="op">=</span> <span class="fl">0.375</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="va">b</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">3</span>, y<span class="op">=</span> <span class="fl">0.75</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="va">e</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">colours</span><span class="op">)</span></span>
<span><span class="va">p2</span></span></code></pre></div>
<p><img src="../reference/figures/barplot_h2_b2.png" style="width:80.0%"></p>
</div>
<div class="section level3">
<h3 id="mean-phenotype-change-across-generations-according-to-selection-strategy">
<strong>Mean phenotype change across generations according to
selection strategy</strong><a class="anchor" aria-label="anchor" href="#mean-phenotype-change-across-generations-according-to-selection-strategy"></a>
</h3>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_phenotypes</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mean_phenotypes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">params_df_it</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span><span class="va">mean_phenotypes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phenotypes_longer</span> <span class="op">&lt;-</span> <span class="va">mean_phenotypes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"^G"</span><span class="op">)</span>, values_to <span class="op">=</span> <span class="st">"Y mean"</span>, names_to <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="st">"Y sd"</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">`Y mean`</span><span class="op">)</span>, </span>
<span>            <span class="st">"Y mean"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">`Y mean`</span><span class="op">)</span>,</span>
<span>            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">`Selection Type`</span>, <span class="va">Generation</span>, <span class="va">h2</span>, <span class="va">b2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"Y mean"</span> <span class="op">=</span> <span class="va">`Y mean`</span> <span class="op">-</span> <span class="va">`Y mean`</span><span class="op">[</span><span class="va">Generation</span> <span class="op">==</span> <span class="st">"G0"</span><span class="op">]</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">`Selection Type`</span>, <span class="va">h2</span>, <span class="va">b2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phenotypes_longer</span><span class="op">$</span><span class="va">`Selection Type`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">phenotypes_longer</span><span class="op">$</span><span class="va">`Selection Type`</span> <span class="op">==</span> <span class="st">"GB"</span>,<span class="st">"TBV"</span>, <span class="va">phenotypes_longer</span><span class="op">$</span><span class="va">`Selection Type`</span><span class="op">)</span></span>
<span></span>
<span><span class="va">colours</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  B <span class="op">=</span> <span class="st">"#ce0104"</span>, </span>
<span>  G <span class="op">=</span> <span class="st">"#0237AE"</span>, </span>
<span>  TBV <span class="op">=</span> <span class="st">"#8123d9"</span>, </span>
<span>  None <span class="op">=</span> <span class="st">"black"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_labeller</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labeller.html" class="external-link">labeller</a></span><span class="op">(</span></span>
<span>  b2 <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html" class="external-link">as_labeller</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"b^2 == "</span>, <span class="va">x</span><span class="op">)</span>, <span class="va">label_parsed</span><span class="op">)</span>,</span>
<span>  h2 <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html" class="external-link">as_labeller</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"h[d]^2 == "</span>, <span class="va">x</span><span class="op">)</span>, <span class="va">label_parsed</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">phenotypes_longer</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">h2</span> <span class="op">==</span> <span class="fl">0.25</span>, <span class="va">b2</span> <span class="op">==</span> <span class="fl">0.25</span>, <span class="va">Generation</span> <span class="op">==</span> <span class="st">"G5"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    label <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">`Selection Type`</span>,</span>
<span>                   B <span class="op">=</span> <span class="st">"BV[m]"</span>,</span>
<span>                   G <span class="op">=</span> <span class="st">"BV[d]"</span>,</span>
<span>                   TBV <span class="op">=</span> <span class="st">"BV[t]"</span>,</span>
<span>                   None <span class="op">=</span> <span class="st">"Random"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">phenotypes_longer</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Generation</span>, y <span class="op">=</span> <span class="va">`Y mean`</span>, group <span class="op">=</span> <span class="va">`Selection Type`</span>, color <span class="op">=</span> <span class="va">`Selection Type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">TRUE</span>, linetype <span class="op">=</span> <span class="fl">0</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">`Selection Type`</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">labels</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">label</span><span class="op">)</span>, parse <span class="op">=</span> <span class="cn">T</span>, hjust <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, vjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.8</span>, direction <span class="op">=</span> <span class="st">"y"</span>, segment.color <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Mean phenotype change"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"#e3e3e3"</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">h2</span><span class="op">)</span>, </span>
<span>             cols <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">b2</span><span class="op">)</span>, </span>
<span>             drop <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>             labeller <span class="op">=</span> <span class="va">custom_labeller</span>,</span>
<span>             switch <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">colours</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">colours</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="../reference/figures/selection_mode.png" style="width:80.0%">
For the selection criteria we have :<br>
- <font color="#ce0104">Red line</font> = Selection on microbiota
breeding values,<br>
- <font color="#0237AE">Blue line</font> = Selection on direct breeding
values,<br>
- <font color="#8123d9">Purple line</font> = Selection on total breeding
values,<br>
- <font color="black">Black line</font> = Random selection</p>
</div>
</div>
<div class="section level2">
<h2 id="selection-index-based-on-a-combination-of-trait-and-diversity-metrics">
<strong>Selection index based on a combination of trait and
diversity metrics</strong><a class="anchor" aria-label="anchor" href="#selection-index-based-on-a-combination-of-trait-and-diversity-metrics"></a>
</h2>
<p>As a first demonstration of the usefulness of RITHMS, we consider a
practical case study of complex breeding program with a multi-trait
objective: maximizing phenotypic change while perserving microbial
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>-diversity.</p>
<p>This section matches code of <strong>Figure 6</strong> of the
paper.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#n_it = 25 was used to generate the figure of the article</span></span>
<span><span class="va">n_it</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span></span>
<span><span class="va">vec_seed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">100</span><span class="op">:</span><span class="fl">10000</span>,<span class="va">n_it</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_df</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>   <span class="op">~</span><span class="va">div</span>,  <span class="op">~</span><span class="va">TBV</span>,</span>
<span>   <span class="fl">0</span>,    <span class="fl">1</span>,</span>
<span>   <span class="fl">1</span>,    <span class="fl">0</span>,</span>
<span>   <span class="fl">0.5</span>, <span class="fl">0.5</span>,</span>
<span>   <span class="fl">0.8</span>, <span class="fl">0.2</span>,</span>
<span>   <span class="fl">0.2</span>, <span class="fl">0.8</span>,</span>
<span>   <span class="fl">0.7</span>, <span class="fl">0.3</span>,</span>
<span>   <span class="fl">0.3</span>, <span class="fl">0.7</span>,</span>
<span>   <span class="fl">0.4</span>, <span class="fl">0.6</span>,</span>
<span>   <span class="fl">0.6</span>, <span class="fl">0.4</span>,</span>
<span>   <span class="fl">0.1</span>, <span class="fl">0.9</span>,</span>
<span>   <span class="fl">0.9</span>, <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="va">vec_seed</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim_ID <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, .before <span class="op">=</span> <span class="st">"div"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>concatenated <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"({div},{TBV})"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">noise</span> <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="va">effect.size</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">0.5</span></span></code></pre></div>
<p>For each iteration, we look at the diversity and the phenotype
values.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_simulation_study</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">it</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">taxa_assign_g</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/formatting_data.html">assign_taxa</a></span><span class="op">(</span><span class="va">founder_object</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">generations_simu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/holo_simu.html">holo_simu</a></span><span class="op">(</span>h2 <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                                b2 <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                                founder_object <span class="op">=</span> <span class="va">founder_object</span>,</span>
<span>                                n_clust <span class="op">=</span> <span class="va">taxa_assign_g</span>,</span>
<span>                                n_ind <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                verbose <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                                noise.microbiome <span class="op">=</span> <span class="va">noise</span>,</span>
<span>                                effect.size <span class="op">=</span> <span class="va">effect.size</span>,</span>
<span>                                lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>                                selection <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                                dir <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                                size_selection_F <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>                                size_selection_M <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>                                selection_type <span class="op">=</span> <span class="st">"div.GB"</span>,</span>
<span>                                w.param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>mean_phenotypes_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">generations_simu</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_mean_phenotypes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         diversities_microbiomes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">generations_simu</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                                          <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_microbiomes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                          <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">richness_from_abundances_gen</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                                          <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">get_mean_diversity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"Generation"</span><span class="op">)</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you want to parallelize the code, you could use
<code>plan(multisession)</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">future_map_dfr</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">params_df</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_it</span><span class="op">)</span>, <span class="op">~</span> <span class="fu">run_simulation_study</span><span class="op">(</span><span class="va">i</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>We look at the differences for our two traits between the base
population and the last generation but it could be any generation.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_phenotypes_y</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">mean_phenotypes_y</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">diversities_microbiomes</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">diversities_microbiomes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diff_y</span> <span class="op">&lt;-</span> <span class="va">mean_phenotypes_y</span><span class="op">$</span><span class="va">G5</span> <span class="op">-</span> <span class="va">mean_phenotypes_y</span><span class="op">$</span><span class="va">G0</span></span>
<span><span class="va">diff_div</span> <span class="op">&lt;-</span> <span class="va">diversities_microbiomes</span><span class="op">$</span><span class="va">G5</span> <span class="op">-</span> <span class="va">diversities_microbiomes</span><span class="op">$</span><span class="va">G0</span></span>
<span></span>
<span><span class="va">diff_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>diff_y <span class="op">=</span> <span class="va">diff_y</span>,</span>
<span>                    diff_div <span class="op">=</span> <span class="va">diff_div</span>,</span>
<span>                    category <span class="op">=</span> <span class="va">params_df</span><span class="op">$</span><span class="va">concatenated</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_data_concat</span> <span class="op">&lt;-</span> <span class="va">diff_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_div <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">diff_div</span><span class="op">)</span>, </span>
<span>                                            mean_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">diff_y</span><span class="op">)</span>, </span>
<span>                                            sd_div <span class="op">=</span> <span class="op">(</span><span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff_div</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                            sd_y <span class="op">=</span> <span class="op">(</span><span class="fl">1.96</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff_y</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                            .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">category</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">diff_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="va">category</span>, <span class="st">"\\(|,.*"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">diff_y</span>, x <span class="op">=</span> <span class="va">diff_div</span>, </span>
<span>             colour <span class="op">=</span> <span class="va">w</span></span>
<span>             <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span>, shape <span class="op">=</span> <span class="fl">20</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diff_data_concat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="va">category</span>, <span class="st">"\\(|,.*"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean_y</span>, x <span class="op">=</span> <span class="va">mean_div</span><span class="op">)</span>, </span>
<span>             shape <span class="op">=</span> <span class="fl">15</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diff_data_concat</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="va">category</span>, <span class="st">"\\(|,.*"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean_y</span>, x <span class="op">=</span> <span class="va">mean_div</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.key.size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="st">'cm'</span><span class="op">)</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>    legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"inside"</span>,</span>
<span>    legend.position.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.49</span>, <span class="fl">0.02</span><span class="op">)</span>,</span>
<span>    legend.justification.inside <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>    legend.direction <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>    legend.box <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Mean phenotype change (over 5 generations)"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Microbial diversity change (over 5 generations)"</span>,</span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">div</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span>, </span>
<span>                        breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">w</span><span class="op">[</span><span class="va">div</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">25</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="../reference/figures/use_case.png" style="width:80.0%"></p>
</div>
<div class="section level2">
<h2 id="future-work">
<strong>Future work</strong><a class="anchor" aria-label="anchor" href="#future-work"></a>
</h2>
<p>It would be interesting to extend the RITHMS model to :<br>
(i) account for <strong>microbial interactions</strong> with a
non-diagonal covariance matrix for the noise component
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>m</mi></msub><annotation encoding="application/x-tex">\sigma_{m}</annotation></semantics></math>
of the taxa abundances,<br>
(ii) allow for the inclusion of <strong>more complex environmental
effects</strong>,<br>
(iii) allow for the <strong>use of semi-complete</strong>, rather than
fully paired, genomic and microbiota data to create the base population,
which would enable RITHMS simulations to be calibrated on a datasets for
which some samples lack genomic or microbiota data,<br>
(iv) the use of RITHMS to alternative <strong>hologenomic
datasets</strong>, notably for a variety of species and experimental
designs, and additional use cases for the evaluation of complex breeding
schemes.</p>
<p><strong>For any ideas or collaboration relating to the package, feel
free to contact : <a href="mailto:solene.pety@inrae.fr" class="email">solene.pety@inrae.fr</a></strong></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Solène Pety, Ingrid David, Mahendra Mariadassou, Andrea Rau, Youna Maillié.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
